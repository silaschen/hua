{extend name='index:base'/}
{block name="main"}


    <div class="container" style="padding-top:20px;padding-bottom:20px;">
      <div class="row">


      {foreach name='cart' item='vo'}

          <div class="col-md-12" style="margin-bottom: 10px;">
            <div class="col-md-3"><img class="img-responsive" style="width:200px;" src="{$Think.config.SERVER}/{$vo['cover']}"></div>
            <div class="col-md-6">
              <h3>{$vo['name']}<span style="color: red;font-size: 15px;">{$vo['price']}</span></h3>
              <p>数量:<input class="form-control num" data-pid="{$vo['pid']}" data-id="{$vo['id']}" data-price="{$vo['price']}"  value="{$vo['num']}"/></p>
            </div>
          </div><hr>

  {/foreach}

</div>
</div>
<button style="font-size20px;height:100px;position:fixed;bottom:0px;z-index:999;" class="btn btn-success btn-block" onclick="payFor()">付款(￥<span id="total">{$total}</span>)</div>

<script type="text/javascript">

  $(".num").bind('input propertychange',function(){
        checkTotal();
  });

  function checkTotal(){
    var data=[];
    $(".num").each(function(k,obj){
        var pid = $(obj).attr('data-pid');
        var price = $(obj).attr('data-price');
        var num = $(obj).val();
        data.push({'pid':pid,'price':price,'num':num});
    });

    console.log(data);


  $.ajax({
    url:"{:url('index/index/checktotal')}",
    data:JSON.stringify(data),
    dataType:'JSON',
    method:"POST",
    success:function(ret){
        if(ret.code===1){
          $("#total").html(ret.total);
        }
    }
  });

}

function payFor(){
  var data=[];
  $(".num").each(function(k,obj){
      var pid = $(obj).attr('data-pid');
      var price = $(obj).attr('data-price');
      var num = $(obj).val();
      data.push({'pid':pid,'price':price,'num':num});
  });

  console.log(data);

$.ajax({
  url:"{:url('index/index/DoOrder')}",
  data:JSON.stringify(data),
  dataType:'JSON',
  method:"POST",
  success:function(ret){
      if(ret.code===1){

          alert('下单成功，请支付');
          $("#orderpay").html(ret.fee);
          $("#pay").modal();

      }
  }
});




}
</script>
{/block}
